# 计算机网络简介

## TCP和UDP常用端口号

​		21 	ftp	文件传输服务

​		22	ssh	安全远程连接服务

​		23	telnet	远程连接服务

​		25	smtp	电子邮件服务

​		53	DNS	域名解析服务

​		80	http	web服务	

​		443	https	安全web服务

​		/etc/services文件中存储了各个端口号对应的服务协议。iptables或netstat要把端口解析成协议名时，其实内部都是调用这个文件：

​			netstat	-antup | grep 22

​			netstat	-atup   | grep ssh

​		**常用ip地址分5类：A,B,C,D,E	常用的是A,B,C三类**

​				A类：范围从0~127,0是保留的并且表示所有IP地址，而127也是保留地址，并且是用于测试回环口用的，因此A类地址实际上从1~126之间，以子网掩码来区别：255.0.0.0

​				B类地址：范围从128~191，如172.168.1.1，以子网掩码进行区别：255.255.0.0

​				C类地址：范围从192~223，以子网掩码进行区别：255.255.255.0

​				D类地址：范围从224~239，被用在多点广播（Muticast）中，多点广播地址用来一次寻址一组计算机，它标识共享同一协议的一组计算机。

E类地址：范围从240~254，为将来留置

ABC3类中私有IP地址范围：

A：10.0.0.0 ----10.255.255.255

B：172.16.0.0 ----172.31.255.255

C：192.168.0.0 ----192.168.255.255

## OSI参考模型

### 		应用层	

​				所有能产生网络流量的应用程序

### 		表示层	

​				在传输之前是否进行加密或压缩	编码方式

### 		会话层	

​				建立特定会话 连接	查木马 	netstat -nb

### 		传输层	

​				可靠传输	流量控制	不可靠传输

### 		网络层	

​				负责选择最佳路径	规划IP地址

### 		数据链路层

​				帧的开始和结束	透明传输	差错校验

### 		物理层	

​				定义了网络设备的接口标准	电气标准	如何在物理链路上更快地传输

### 		OSI参考模型对网络排错指导：

​				物理层故障	查看网线连接状态 	发送和接收的数据包

​				数据链路层故障	MAC地址冲突	ADSL光猫欠费断开的是数据链路层	网速不协调 

​				网络层故障	分配IP地址错误	网关配置错误	子网掩码配置错误	路由器上没有到达目标地址的路由

​				应用层故障	应用程序配置错误	如浏览器配置了错误的代理

### 		OSI参考模型与网络安全

​				物理层安全	网线接入

​				数据链路层安全	ADSL账号密码	WLAN交换机端口绑定MAC地址

​				网络层安全	在路由器上使用ACL控制数据包流量	防火墙设置

​				应用层安全	开发的应用程序漏洞	

​				网络层只负责不同网络之间尽力转发数据，不负责丢包重传，不负责顺序，这些是传输层控制的。

#### 					路由器---网络层设备		交换机------>数据链路层设备			网线、集线器-------->物理层

# 网络层协议

## 	**IP协议**	

​			负责将数据包从一个网段转发到另一个网段

​			负责将不得同网段之间转发数据包，顺序也不管，丢失也不管，只选择不同出口，即路由选择。

### 			路由表

​					管理员添加的**静态路由**、或由RIP协议/OSPF协议等等IP协议学习**动态路由**

​			所有能够使路由器学习路由表的协议都叫IP协议。

### 			网络畅通的条件

​					数据包能去也能回 。必须配置网关，必须知道路由表

### 		**静态路由**

​				需要管理员告诉路由器**所有**未直连的网段下一跳给哪一个路由器		缺点：适合小规模网络 	不能自动调整路由

### 		**动态路由**

#### 			RIP协议

​				周期性广播路由表，30s广播一次，根据跳数少的选择路由路径，最大跳数为15跳。一个跳数就是经过一个路由器。

#### 			OSPF协议：

​					选择路由的标准不是跳数而是带宽

## ARP协议	

​		将IP地址解析成物理层MAC地址。

​		将IP地址通过广播，目标MAC地址是FF-FF-FF-FF-FF-FF	解析目标IP地址的MAC地址	只能解析本网段内

​		也只能广播本网段内	跨不了路由器

## **RARP协议**

​		（Reverse Address Resolution Protocol），反向地址转换协议	就是将局域网中某个主机的物理地址转换为IP地址，比如局域网中有一台主机只知道物理地址而不知道IP地址，那么可以通过RARP协议发出征求自身IP地址的广播请求，然后由RARP服务器负责回答。RARP协议广泛用于获取无盘工作站的IP地址。

​		反向地址转换协议（RARP）允许局域网的物理机器从网关服务器的 ARP 表或者缓存上请求其 IP 地址。[网络管理员](https://baike.baidu.com/item/网络管理员)在局域网网关[路由器](https://baike.baidu.com/item/路由器)里创建一个表以映射物理地址（MAC）和与其对应的 IP 地址。当设置一台新的机器时，其 RARP [客户机](https://baike.baidu.com/item/客户机)程序需要向路由器上的 RARP 服务器请求相应的 IP 地址。假设在[路由表](https://baike.baidu.com/item/路由表)中已经设置了一个记录， RARP 服务器将会返回 IP 地址给机器，此机器就会存储起来以便日后使用。	

工作原理：	

1. 给主机发送一个本地的RARP广播，在此广播包中，声明自己的MAC地址并且请求任何收到此请求的RARP服务器分配一个IP地址；

2. 本地网段上的RARP服务器收到此请求后，检查其RARP列表，查找该MAC地址对应的IP地址；

3. 如果存在，RARP服务器就给源主机发送一个响应数据包并将此IP地址提供给对方主机使用；

4. 如果不存在，RARP服务器对此不做任何的响应；

5. 源主机收到从RARP服务器的响应信息，就利用得到的IP地址进行通讯；如果一直没有收到RARP服务器的响应信息，表示初始化失败。

## ICMP协议

​		网际控制报文协议	测试网络层是否存在故障	使路由器能够使用ICMP协议报告路由错误

​		**ping命令**	time 查看延迟		

​		**TTL**可以大致判断服务器系统：默认情况下Linux 64	Windows 128 	Unix 255	(可以更改的)

​		ping	10.0.0.0  -t	表示一直PING下去

​		ping	10.0.0.0  -l  200	指定ping包大小为200K，最大65500

​		ping	10.0.0.0 -i	2	指定ping包中TTL值为2，能够跟踪数据包途经的路由器

​		请求超时 是包到达目标主机却不能返回

​		不可到达 是包到达不了目标主机

​		**pathping**命令	跟踪数据包路径 	计算丢包情况

​			pathping	10.0.0.0

​		还有一个命令也有pathping的功能：

​		windows上：**tracert**	10.0.0.0	跟踪数据包经过的路径

​		路由器上：**traceroute**	10.0.0.0	

## **IGMP协议**	

​		internet组播管理协议

​		点到点通讯

​		广播通讯

​		组播=多播通讯		不建立会话

## **IP数据包结构：	首部+数据部分**

​		数据链路层 最大传输单元MTU数据最大1500字节	|	网络层数据包	数据最大65535字节

​		**数据部分**	如果不分片，数据包数据最大不超过1480个字节。如果网络层下来的数据包超过1500个字节，则要编号分片传输，分片传输的片包会分别加上ip，独自选择路由到达目的主机，再合并成完整包。假如，分片传输至目标计算机的数据包不完整，计算机会一直等待剩余片包等待重组成完整包，“泪滴攻击”即是：向目标机器发送损坏的IP包，诸如重叠的包或过大的包载荷，借由这些手段，该攻击可以通过TCP/IP协议栈中分片重组代码中的bug来瘫痪各种操作系统。

​		**首部 	一共20个字节	固定大小**

​			版本	用来表示TCP/IP协议的版本号	v4、v6

​			区分服务	QoS	实现数据包的传输优先级设定	windows 2008 上使用gpedit.msc组策略工具编辑

​			总长度：数据包的总长度

​			标识：2个字节，用以标识分片包的某一组分片，组内是相同的值

​			标志：占3位，目前只有前两位有意义，标志最低位是MF（more fragment），MF=1表示后面还有分片，=0表示最后一个分片。标志位中间一位是DF（don't fragment），只有当DF=0时才允许分片。

​			片偏移：分片的第一个字节是整个包第几个字节

​			生存时间：每过一个路由器，TTL值都会更改，为0时数据包就会湮灭

​			**协议号**：标识数据部分是哪类协议，如UDP为17、TCP为6、ICMP为1、IGMP为2、OSPF为89、IPv6为41

​			首部检验和：两个字节，用以校验数据传输过程中首部是否更改或出现错误

​			源地址：32位二进制

​			目标地址：

​			可变部分：可选字段+填充。会增加路由负担。IPv6已经使其为固定值了。

# 传输层协议

## **TCP协议**

​		需要将传输文件分段	传输会建立会话 	是可靠传输	有流量控制		QQ传输文件是TCP协议

## **UDP协议**

​		数据包较小	一个数据包就能够完成数据通信	不分段	不需要建立会话	不需要流量控制	是不可靠传输	域名解析用的就是UDP协议	QQ聊天也是UDP协议

## **TCP/UDP+端口	用以标识应用层协议**

​		TCP+3389		RDP协议

​		TCP+21			FTP协议

​		TCP+23			TELNET协议

​		TCP+25			SMTP协议（发邮件）

​			TCP+110		POP3协议（收邮件）

​		TCP+80			HTTP协议

​		TCP+443			HTTPS协议

​		TCP+3389		RDP协议（windows远程桌面）

​		TCP+445			windows共享文件夹

​		TCP+1433		微软服务器SQLServer

​		UDP/TCP+53		DNS协议(大多数使用UDP)

​		UDP+69			TFTP协议

​		UDP+161			SNMP协议

​		UDP+520			RIP协议

服务使用TCP/UDP的端口侦听客户端请求	客户端使用IP地址定位服务器，通过在数据包加上端口号来定位访问相应服务	可以在服务器网卡上设置只开放必要端口来实现服务器网络安全。端口扫描猜服务，进而通过服务漏洞入侵。

## **如何查看服务侦听的端口：**

​		netstat 	-n 	查看会话

​		netstat	-nb	查看建立会话的进程

​		netstat 	-an	查看服务侦听的端口

​		telnet	192.168.80.100	3389	**测试**到远程计算机（如192.168.80.100）某个端口（如3389）是否访问，不加端口号默认检查23端口

## **更改服务使用的默认端口：**

​		可以迷惑入侵者，使系统更加安全

## **如何设置windows服务器网路安全：**

​		设置本地连接	TCP/IP筛选	通过开启/关闭windows服务器网卡处允许访问的端口或服务：本地连接-->Internet协议-->属性-->高级-->选项-->属性-->只允许

​		**传输层实现的服务**是程序到程序，为相互通信的应用进程提供了逻辑通信，即进程之间的逻辑通信

​		**网络层实现的服务**是服务器到服务器（地址到地址），即主机之间的逻辑通信

## TCP的端口

​		端口用一个16位端口号进行标志	0~65535

​		熟知端口	0~1023

​		登记端口号	1024~49151	（开发应用程序使用）

​		客户端口号	49152~65535	

​		netstat 	-n |	find	"ESTABLISHED"	查找已建立连接的端口  

​		**TCP协议特点：**实现可靠传输		实现流量控制		避免网络拥塞

## TCP如何实现可靠传输

​		可靠传输的原理--**停止等待协议**

​		无差错情况传输	超时重传	确认丢失	确认迟到	

​		确认和重传机制，我们就可以在不可靠的传输网络上实现可靠的通信。这种可靠传输协议常称为自动重传请求ARQ（automatic	repeat 	quest）。ARQ表明重传的请求是**自动**进行的。接收方不需要请求发送方重传某个出错的分组。

​		停止等待协议优点是简单，缺点是信道利用率太低。

​		**流水线传输（连续ARQ协议）**：发送方可连续发送多个分组，不必发完一个分组就停顿下来等待对方确认。由于信道上一直有数据不间断传输，这种传输方式可获得很高信道利用率。（滑动窗口技术/累积确认技术）。

### 	TCP首部格式

​		（20字节固定首部+可变长度选项。最长60个字节）

​		源端口：2个字节，

​		目的端口：2个字节，

​		序号：4个字节，这个分段的第一个字节是整个数据的第多少个字节

​		确认号：4个字节，接收端告诉发送端，给发送端的确认，让其下一次分段该发哪一个字节

​		数据偏移：分辨TCP报文段是从第多少个字节开始以后是数据部分。即首部有多长，首部之后的部分都是数据部分。

​		保留：未使用区域。

​		URG标志位：urgent。加塞标记位，为1时，发送端在发送这个分段时是不排队的，优先传输。

​		ACK标志位： acknowledge。发起会话请求时，ACK为0，请求被同意后，ACK为1，表示同意建立连接。为1时，确认号才有用

​		PSH标志位：push。为1时，接收端接收到分段数据后，直接将其提交给应用层，而不等待组装。

​		RST标志位：reset。为1时，表明TCP连接出现严重错误，需要释放资源重新建立连接。

​		SYN标志位：为1时，发起会话请求。有专门针对XP系统建立会话请求的**SYN攻击**:伪造一堆地址与目标地址建立会话请求。**land攻击**：直接利用目标地址与目标地址建立会话请求。

​		FIN标志位：数据通讯结束后，数据传完了，要释放连接时，FIN为1。

​		窗口：两个字节。接收/发送数据缓存大小。

​		检验和：两个字节，与UDP校验和基本一样。

​		紧急指针：两个字节。只有在URG为1时才起作用。指明了需要紧急处理的数据的尾部，即在整个数据中的结束位置。

​		选项：长度可变，最多40个字节。可有可无。可以规定最大数据包的长度。可以规定是不是支持选择性确认SACK（安全性连接）。等等功能。

​		填充：填充位。

## TCP如何实现流量控制

​		接收端告诉发送端，其接收窗口（rwnd）有多大来实现的 	滑动窗口技术（rwnd）。

## TCP的拥塞控制

​		慢开始算法

​		快恢复算法

​		快重传算法

​		发送方的发送窗口上限值应当取接收方窗口和拥塞窗口这两个变量中较小的那个。		

## TCP的传输连接管理

​		传输连接的三个阶段：A发送端	B接收端

​				**建立连接**：三次握手		1.	A--->B	SYN=1	ACK=0	seq=x	此时发送端状态为SYN-SEND

​														 2.	B--->A	SYN=1	ACK=1	seq=y	ack=x+1		此时接收端状态为SYN-RCVD

​														 3.	A--->B	ACK=1	seq=x+1	ack=y+1		此时发送端/接收端 状态为ESTABLISHED

​				**连接释放**：	1.	A--->B	FIN=1	seq=u		数据传输结束后，通信双方都可释放连接。现在A的应用进程先向其TCP发出连接释放报文段，并停止再发送数据，主动关闭TCP连接。A把连接释放报文段首部的FIN=1，其序号seq=u，等待B确认。		A状态为FIN-WAIT-1		

​							 		2.	B--->A	ACK=1	seq=v	ack=u+1	B发出确认，确认号ack=u+1，而这个报文段自己的序号seq=v。TCP服务器进程通知高层应用进程。从A到B这个方向的连接就释放了，TCP连接处于半关闭状态。B若发送数据，A仍要接收。		B状态为CLOSE-WAIT

​									 3.	B--->A	FIN=1	ACK=1	seq=w	ack=u+1	若B没有要向A发送的数据，其应用进程就通知TCP释放连接			A状态为FIN-WAIT-2	B状态为LAST-ACK

​									4.	A--->B	ACK=1	seq=u+1	ack=w+1	A收到连接释放报文段后，必须发出确认。A状态为TIME-WAIT		B状态为CLOSED

# 应用层协议

## DNS协议		

​		域名解析服务	将域名解析成ip地址（服务器-客户机结构）

​		域名

​				根域名：		**.**		 

​				顶级域名：	com	edu	net	cn	org	gov	

​				二级域名：	huawei	xiaomi	可申请	需交费

​				三级域名：	dba	不用多缴费				

​		**8.8.8.8	谷歌DNS服务器			222.222.222.222	电信DNS服务器**

​		ping命令	可以显示域名与IP		ping	www.souhu.com

​		nslookup命令	显示域名解析		nslookup	www.souhu.com

​		域名解析的过程：分布式

​		安装自己的DNS服务器应用场景：		1.为了解析内网自己的域名

  																	 2.降低到Internet的域名解析流量

​																		3.域环境

## DHCP协议		

​		动态主机配置协议（服务器-客户机结构）

​		DHCP服务器使用DHCP协议为下面的那些计算机分配动态的IP地址、网关、子网掩码、DNS。

​		**客户端计算机请求IP地址的过程**：是在网上发广播的，交换机收到广播之后，会把这个数据包转给所有的口，这个过程其实是由计算机的网卡MAC地址去找对应的IP地址是多少，即知道MAC地址来解析IP地址。而ARP协议中，是想知道某个IP地址的MAC地址，即由IP地址来解析MAC地址，也靠广播。所以DHCP其实是逆向ARP

​		静态IP地址			动态IP地址

​		DHCP服务器必须是固定地址

### 		DHCP分配地址过程

​				本网段内的客户机请求地址是向DHCP服务器发广播包，DHCP直接收到。		

​				外网段内的客户机请求地址是向通过配置路由器发一个DHCP中继包信息给DHCP服务器，中继包信息包含网段信息。进行配置。

### 		**本网段分配地址**

​				DHCP如果要为本网段内客户机分配地址，则提供的服务地址区域要设置在DHCP服务器所在网段内。

​				客户机释放租约获得的动态IP地址：ipconfig	/release

​				客户机请求租约重新获得动态IP地址：	ipconfig	/renew

​				计算机有个服务--DHCP	Client	如果这个服务被停掉了，计算机就不会自动获得IP地址了。

### 		**跨网段分配地址**

​				创建不同网段作用域，配置相对应的网关等信息。在不同网段的路由器的网段对应接口添加命令：**ip helper-address  DHCP服务器IP地址**

## FTP协议		

​		文件传输协议	file 	 transform 	protocol

### FTP连接方式

​		控制连接：标准端口为21，用于发送FTP命令信息

​		数据连接：标准端口为20，用于上传、下载数据

#### 		数据连接的建立类型

​				**主动模式**：服务端从20端口主动向客户端发起连接。

​				**被动模式**：服务端在指定范围内的某个端口被动等待客户端发起连接

​				**主动模式防火墙需要打开21和20端口**：FTP客户机通过TCP的21端口访问FTP服务器；FTP服务器需要通过20端口向客户机传输数据

​				**被动模式防火墙只打开21 和20端口**：被动模式下FTP不能下载数据。FTP客户机通过TCP的21端口访问FTP服务器；服务端在指定范围内的某个端口被动等待客户端发起连接

​		**所以，如果FTP服务器端如果有防火墙，需要在防火墙开20和21端口，适用主动模式进行数据连接。**

​				netstat -n	查看端口使用可以判断是哪种模式	 

#### 		服务器端的端口开闭

​				本地连接--->TCP/IP连接----->高级----->选项----->TCP/IP筛选----->属性

#### 		使用哪种模式完全由客户机设置

​				Internet选项----->高级---->（勾选）使用被动FTP。**被动模式下访问不了ftp服务器**

### **FTP传输模式**

​		文本模式：ASCII模式，以文本序列传输数据

​		二进制模式：Binary模式，以二进制序列传输数据







































